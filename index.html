<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC2054çš„åšå®¢</title>
    <style>
        :root { 
            --primary-color: #007bff;   
            --primary-light: #e9f5ff;
            --primary-hover: #0056b3;
            --nav-font-size: 16px;     
            --nav-font-weight: bold;   
            --post-spacing: 7px; 
            --border-color: #e5e7eb;
            --bg-color: #f8fafc;
            --text-gray: #6b7280;
            --text-dark: #1f2937;
            --highlight-bg: #e9f5ff; /* ç»Ÿä¸€é«˜äº®èƒŒæ™¯è‰² */
        }
        * { box-sizing: border-box; transition: all 0.2s ease; margin: 0; padding: 0; }
        body { font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; margin: 0; color: var(--text-dark); background-color: var(--bg-color); line-height: 1.6; }
        .container { max-width: 1024px; margin: 10px auto; padding: 10px; background: #fff; border-radius: 10px; box-shadow: 0 2px 25px rgba(0,0,0,0.03); }
        
        header { text-align: center; margin-bottom: 10px; }
        .avatar { width: 108px; height: 108px; border-radius: 50%; border: 2px solid var(--border-color); margin-bottom: 8px; object-fit: cover; }
        h1 { margin: 3px 0; font-size: 34px; font-weight: 800; letter-spacing: 1px; }
        .subtitle { color: var(--text-gray); font-size: 15px; margin-bottom: 10px; }

        /* âœ… æ ¸å¿ƒä¼˜åŒ–ï¼šå¯¼èˆªæ æ·»åŠ åŒæ¬¾é«˜äº®èƒŒæ™¯è‰²+åœ†è§’ */
        nav { 
            background: var(--highlight-bg); border-radius: 8px;
            position: relative; z-index: 100; padding: 0 20px; 
            margin-bottom: 20px;
        }
        .nav-list { display: flex; justify-content: center; list-style: none; gap: 8px; padding: 8px 0; flex-wrap: wrap; }
        .nav-item { position: relative; }
        .nav-link { display: block; padding: 12px 20px; text-decoration: none; color: var(--text-dark); cursor: pointer; font-size: var(--nav-font-size); font-weight: var(--nav-font-weight); position: relative; border-radius: 6px; }
        .nav-link:hover { color: var(--primary-color); background: rgba(255,255,255,0.6); }
        .nav-link.active { color: var(--primary-color); background: rgba(255,255,255,0.8); }
        .nav-link::after { display: none; }

        .dropdown { position: absolute; top: 100%; left: 0; background: #fff; min-width: 180px; white-space: nowrap; display: none; list-style: none; padding: 8px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-radius: 8px; margin-top: 4px; z-index: 99; }
        .nav-item:hover > .dropdown { display: block; }
        .dropdown a { display: block; padding: 10px 20px; text-decoration: none; color: var(--text-dark); font-size: 14px; cursor: pointer; border-radius: 4px; }
        .dropdown a:hover { background: var(--highlight-bg); color: var(--primary-color); padding-left: 20px; }

        .post-count { text-align: center; font-size: 14px; color: var(--text-gray); margin-bottom: 20px; padding: 8px; background: var(--highlight-bg); border-radius: 8px; }
        .post-list-wrapper { margin-top: 0; border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; }
        .post-item { display: flex; justify-content: space-between; align-items: center; padding: var(--post-spacing) 34px; border-bottom: 1px solid var(--border-color); text-decoration: none; color: inherit; }
        .post-item:last-child { border-bottom: none; }
        .post-item:hover { background: #f9fbff; transform: translateX(2px); }
        .post-title { color: var(--primary-color); font-size: 17px; flex: 1; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 15px; }
        
        .post-meta { display: flex; align-items: center; gap: 15px; flex-shrink: 0; }
        .post-cat-tag { font-size: 12px; color: var(--text-gray); background: #f3f4f6; padding: 3px 10px; border-radius: 12px; }
        .post-date { color: var(--text-gray); font-size: 14px; font-family: monospace; }

        /* åˆ†é¡µæ ·å¼ */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 25px; }
        .page-btn { padding: 8px 16px; border: 1px solid var(--border-color); background: #fff; cursor: pointer; border-radius: 8px; font-size: 14px; }
        .page-btn:hover:not(:disabled) { border-color: var(--primary-color); color: var(--primary-color); background: var(--primary-light); }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; background: #f9fafb; }

        /* ç®¡ç†é¢æ¿æ ·å¼ */
        #admin-trigger { position: fixed; bottom: 25px; right: 25px; background: #1f2937; color: #fff; padding: 12px 18px; border-radius: 50px; cursor: pointer; font-size: 13px; z-index: 999; opacity: 0.6; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        #admin-trigger:hover { opacity: 1; transform: scale(1.05); }
        #admin-panel { display: none; position: fixed; top: 2%; left: 2%; width: 96%; height: 96%; background: white; border: 1px solid var(--border-color); box-shadow: 0 0 40px rgba(0,0,0,0.15); z-index: 1000; overflow-y: auto; padding: 30px; border-radius: 12px; }
        .admin-section { margin-bottom: 20px; border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; background: #f9fafb; }
        input, select { padding: 12px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; outline: none; }
        input:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-light); }
        .required-tip { color: #dc2626; font-size: 12px; margin-left: 6px; vertical-align: middle; }
        .btn-main { color: white; border: none; padding: 12px 22px; border-radius: 8px; cursor: pointer; font-weight: bold; flex-shrink: 0; }
        .btn-add { background: #10b981; }
        .btn-add:hover { background: #059669; }
        .btn-edit { background: #f59e0b; color: #1f2937 !important; }
        .btn-edit:hover { background: #d97706; }
        .save-btn { background: var(--primary-color); color: white; padding: 16px 30px; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; margin-top: 10px; }
        .save-btn:hover { background: var(--primary-hover); }
        .admin-action-btn { border: none; background: none; cursor: pointer; font-size: 14px; margin-left: 12px; padding: 4px 8px; border-radius: 4px; }
        .admin-action-btn:hover { background: #f3f4f6; }

        /* åšå®¢é…ç½®ç¼–è¾‘åŒº */
        .blog-config-form { display: flex; gap:12px; flex-wrap: wrap; margin-bottom:10px; }
        .blog-config-form input { flex:1; min-width:200px; }

        /* ç©ºæ•°æ®å ä½ */
        .empty-tip { text-align: center; padding: 40px 20px; color: var(--text-gray); font-size:15px; }
        
        /* ç¼–ç å¼èœå•æ ·å¼ */
        #menu-editor input { padding:6px 8px; border:1px solid #ddd; border-radius:4px; font-size:13px; width:auto; }
        #menu-editor button { padding:4px 8px; border:1px solid #ddd; border-radius:4px; font-size:12px; cursor:pointer; background:#fff; margin-left:5px; }
        #menu-editor button:hover { background:#f5f5f5; }
        #menu-editor button[style*="red"] { border-color:#f00; color:#f00; }
        #add-root-menu-btn { padding:6px 12px; border:1px solid #ddd; border-radius:4px; background:#fff; cursor:pointer; font-size:12px; margin-top:8px; }
        #menu-editor .code-input { width:60px; text-align:center; margin-right:8px; }

        /* âœ… æ ¸å¿ƒä¼˜åŒ–ï¼šå½•å…¥åšæ–‡è¡¨å• - æè‡´ç´§å‡‘+å¿…å¡«è´´å³ä¾§ */
        .post-form-row { display: flex; align-items: center; gap: 3px; margin-bottom: 8px !important; width: 100%; }
        .post-form-full { width: 100%; flex: unset !important; }
        .post-form-short { flex: 0 0 200px; max-width: 200px; }
        .post-form-btn-group { margin-left: auto; flex-shrink: 0; display: flex; gap: 8px; align-items: center; }
        /* âœ… æ–°å¢æ£€ç´¢æ ·å¼ï¼šå’ŒåŸæœ‰è¡¨å•æ ·å¼ç»Ÿä¸€ */
        .search-input { flex: 0 0 220px; max-width: 220px; padding:12px 14px; border-radius:8px; border:1px solid var(--border-color); font-size:14px; }
        .search-select { flex: 0 0 180px; max-width: 180px; padding:12px 14px; border-radius:8px; border:1px solid var(--border-color); font-size:14px; }
    </style>
</head>
<body>

<div class="container">
    <header id="blog-header"></header>
    <!-- âœ… å¸¦é«˜äº®èƒŒæ™¯çš„å¯¼èˆªæ  -->
    <nav id="blog-nav"></nav>
    <div id="post-count" class="post-count"></div>
    <div id="blog-content-area">
        <div class="post-list-wrapper" id="post-list"></div>
        <div id="blog-pagination" class="pagination"></div>
    </div>
    <footer style="text-align: center; margin-top: 60px; color: #9ca3af; font-size: 13px; padding-bottom: 20px;">
        <div id="footer-info">Â© 2024-2025 BTC2054 ç‰ˆæƒæ‰€æœ‰ | ä¿ç•™æ‰€æœ‰æƒåˆ©</div>
        <div id="website-days" style="margin-top: 8px; color: #9ca3af;"></div>
    </footer>
</div>

<div id="admin-trigger" onclick="toggleAdmin()">âš™ åšå®¢ç®¡ç† V1.1</div>

<div id="admin-panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:20px;">
        <h2 style="margin:0; color:var(--text-dark);">åšå®¢åå°ç®¡ç†</h2>
        <button class="page-btn" onclick="toggleAdmin()">âœ• å…³é—­é¢æ¿</button>
    </div>
    <hr style="margin:0 0 20px 0; border-color:var(--border-color);">
    
    <!-- åšå®¢åŸºç¡€ä¿¡æ¯ç¼–è¾‘åŒº -->
    <div class="admin-section">
        <h3>ğŸ“Œ åšå®¢åŸºç¡€ä¿¡æ¯è®¾ç½®</h3>
        <div class="blog-config-form">
            <input type="text" id="config-title" placeholder="åšå®¢æ ‡é¢˜" value="">
            <input type="text" id="config-subtitle" placeholder="åšå®¢å‰¯æ ‡é¢˜" value="">
            <input type="text" id="config-avatar" placeholder="å¤´åƒå›¾ç‰‡URL" value="">
            <button class="btn-main btn-add" onclick="saveBlogConfig()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <!-- âœ… æè‡´ç´§å‡‘ç‰ˆå½•å…¥åšæ–‡è¡¨å• + æ–°å¢æ£€ç´¢åŠŸèƒ½ -->
    <div class="admin-section" id="admin-entry-form">
        <h3 id="form-title" style="margin-bottom:12px;">ğŸ“ å½•å…¥åšæ–‡</h3>
        <!-- æ ‡é¢˜è¡Œï¼šå¿…å¡«è´´å³ä¾§ï¼Œæ— æ¢è¡Œ -->
        <div class="post-form-row">
            <input type="text" id="new-p-title" placeholder="åšæ–‡æ ‡é¢˜" required class="post-form-full">
            <span class="required-tip">*</span>
        </div>
        <!-- é“¾æ¥è¡Œï¼šå¿…å¡«è´´å³ä¾§ï¼Œæ— æ¢è¡Œ -->
        <div class="post-form-row">
            <input type="text" id="new-p-url" placeholder="åšæ–‡é“¾æ¥URL" required class="post-form-full">
            <span class="required-tip">*</span>
        </div>
        <!-- æ—¶é—´åˆ†ç±»è¡Œï¼šæè‡´ç´§å‡‘ + âœ… æ–°å¢æ£€ç´¢æ ï¼ˆå‘å¸ƒæŒ‰é’®å·¦ä¾§ï¼‰ -->
        <div class="post-form-row">
            <input type="date" id="new-p-date" class="post-form-short">
            <select id="new-p-cat" class="post-form-short"></select>
            <!-- âœ… æ ¸å¿ƒæ–°å¢ï¼šæ£€ç´¢æ  - æ ‡é¢˜æ£€ç´¢ + åˆ†ç±»ç­›é€‰ï¼Œæ”¾åœ¨å‘å¸ƒæŒ‰é’®å·¦ä¾§ -->
            <input type="text" id="search-title" class="search-input" placeholder="ğŸ” æ£€ç´¢åšæ–‡æ ‡é¢˜" oninput="searchPosts()">
            <select id="search-cat" class="search-select" onchange="searchPosts()">
                <option value="all">ğŸ“‚ å…¨éƒ¨åˆ†ç±»</option>
            </select>
            <div class="post-form-btn-group">
                <button id="submit-btn" class="btn-main btn-add" onclick="handlePostSubmit()">âœ… å‘å¸ƒ</button>
                <button id="cancel-edit-btn" style="display:none; padding:12px 22px; border-radius:8px; border:1px solid var(--border-color); cursor:pointer;" onclick="cancelEdit()">âŒ å–æ¶ˆ</button>
            </div>
        </div>
        
        <div id="admin-post-list-wrapper">
            <div id="admin-post-list" style="max-height: 400px; overflow-y: auto; background: #fff; border: 1px solid var(--border-color); border-radius:8px; margin-top:10px;"></div>
            <div id="admin-pagination" class="pagination"></div>
        </div>
    </div>
    
    <!-- ç¼–ç å¼å¯¼èˆªèœå•ç®¡ç† -->
    <div class="admin-section">
        <h3 style="margin-bottom:8px;">2. å¯¼èˆªèœå•ç®¡ç†</h3>
        <div style="font-size:12px; color:#666; margin-bottom:6px;">ğŸ’¡ ç¼–ç è§„åˆ™ï¼š<br> ä¸€çº§=çº¯æ•°å­—(1ã€2ã€3) <br> äºŒçº§=çˆ¶ç¼–ç -åºå·(2-1)<br> ä¸‰çº§=çˆ¶ç¼–ç -åºå·(2-1-1)<br> è°ƒæ•´å¯¹åº”çš„åºå·å³å¯è‡ªåŠ¨è°ƒæ•´å½’å±å…³ç³» <br> <br></div>
        <div id="menu-editor"></div>
        <button id="add-root-menu-btn" onclick="addRootMenu()">+ æ·»åŠ ä¸€ä¸ªå¯¼èˆªèœå•</button>
    </div>
    
    <div class="admin-section" style="background: var(--highlight-bg);">
        <button class="save-btn" onclick="exportAndSave()">ğŸ’¾ ä¿å­˜æ‰€æœ‰æ•°æ®å¹¶ä¸‹è½½ index.html</button>
    </div>
</div>

<script id="data-storage">
/* æ•°æ®å­˜å‚¨åŒº - ç¼–ç å¼èœå•æ•°æ® */
let blogConfig = {"title": "BTC 2054", "subtitle": "Salvation lies within", "avatar": "https://www.btc2054.com/IMG/90368994.jpg"};
let menuData = [
    {"id": "m1", "code": "1", "name": "é¦–é¡µ", "children": []},
    {"id": "m2", "code": "2", "name": "æˆ‘çš„è®¡åˆ’", "children": [
        {"id": "m1735640348731", "code": "2-1", "name": "2054å…»è€è®¡åˆ’", "children": []}
    ]}
];
let postData = [
    {"title": "2024å¹´4æœˆï¼šå®šå­˜åˆå§‹ç¯‡", "date": "2024-04-01", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202404chushi/202604chushi.html"},
    {"title": "2024å¹´04æœˆï¼šå®šå­˜ç¬¬1/360æœŸã€+7.04% ", "date": "2024-04-30", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202404/202404.html"},
    {"title": "2024å¹´05æœˆï¼šå®šå­˜ç¬¬2/360æœŸã€+1.10%", "date": "2024-05-31", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202405/202405.html"},
    {"title": "2024å¹´06æœˆï¼šå®šå­˜ç¬¬3/360æœŸã€+2.97%", "date": "2024-06-30", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202406/202406.html"},
    {"title": "2024å¹´07æœˆï¼šå®šå­˜ç¬¬4/360æœŸã€+5.18%", "date": "2024-07-31", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202407/202407.html"},
    {"title": "2024å¹´08æœˆï¼šå®šå­˜ç¬¬5/360æœŸã€è¢«å¥—ä¸­", "date": "2024-08-31", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202408/202408.html"},
    {"title": "2024å¹´09-10æœˆï¼šå®šå­˜ç¬¬6-7/360æœŸã€æŒç»­è¢«å¥—ä¸­ã€‚ã€‚ã€‚", "date": "2024-10-31", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202409-10/202409-10.html"},
    {"title": "2024å¹´11æœˆï¼šå®šå­˜ç¬¬8/360æœŸã€ç»ˆäºè§£å¥—äº†!!!", "date": "2024-11-30", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202411/202411.html"},
    {"title": "2024å¹´12æœˆï¼šå®šå­˜ç¬¬9/360æœŸã€å›å½’å®šæŠ•æœ¬è´¨ï¼Ÿï¼Ÿ", "date": "2024-12-31", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202412/202412.html"},
    {"title": "2025å¹´01æœˆï¼šå®šå­˜ç¬¬10/360æœŸã€+1%", "date": "2025-01-31", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202501/202501.html"},
    {"title": "2025å¹´02æœˆï¼šå®šå­˜ç¬¬11/360æœŸã€-7.37%", "date": "2025-02-28", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202502/202502.html"},
    {"title": "2025å¹´03æœˆï¼šå®šå­˜ç¬¬12/360æœŸã€+0.26%", "date": "2025-03-31", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202503/202503.html"},
    {"title": "2025å¹´04æœˆï¼šå®šå­˜ç¬¬13/360æœŸã€-0.56%", "date": "2025-04-30", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202504/202504.html"},
    {"title": "2025å¹´05æœˆï¼šå®šå­˜ç¬¬14/360æœŸã€+20.7%", "date": "2025-05-31", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202505/202505.html"},
    {"title": "2025å¹´06æœˆï¼šå®šå­˜ç¬¬15/360æœŸã€+1.56%", "date": "2025-06-30", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202506/202506.html"},
    {"title": "2025å¹´07æœˆï¼šå®šå­˜ç¬¬16/360æœŸã€+10.48%", "date": "2025-07-31", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202507/202507.html"},
    {"title": "2025å¹´08æœˆï¼šå®šå­˜ç¬¬17/360æœŸã€+1.66%", "date": "2025-08-31", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202508/202508.html"},
    {"title": "2025å¹´09æœˆï¼šå®šå­˜ç¬¬18/360æœŸã€+2.58%", "date": "2025-09-30", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202509/202509.html"},
    {"title": "2025å¹´10æœˆï¼šå®šå­˜ç¬¬19/360æœŸã€+0.87%ã€æ›´æ–°è®¡åˆ’V1.1", "date": "2025-10-31", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202510/202510.html"},
    {"title": "2025å¹´11æœˆï¼šå®šå­˜ç¬¬20/360æœŸã€-0.41%", "date": "2025-11-30", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202511/202511.html"},
    {"title": "2025å¹´12æœˆï¼šå®šå­˜ç¬¬21/360æœŸã€+8.5%ã€é¦–ä¸ªé‡Œç¨‹ç¢‘", "date": "2025-12-31", "categoryId": "m1735640348731", "url": "https://www.btc2054.com/Blog/2054YangLao/202512/202512.html"}
];

let blogPage = 1, adminPage = 1, pageSize = 20
let currentEditingIndex = null;
let currentViewCatId = 'all';

// åˆå§‹åŒ–å…¥å£
function init() { 
    renderBlog(); 
    renderAdminPostList(); 
    renderMenuEditor();
    initBlogConfigForm();
    const start = new Date('2024-03-15');
    const diff = Math.floor((new Date() - start) / (1000 * 60 * 60 * 24));
    document.getElementById('website-days').innerText = `åšå®¢å·²ç¨³å®šè¿è¡Œ ${diff} å¤© âœ¨`;
    document.getElementById('new-p-date').valueAsDate = new Date();
}

// æ ¹æ®åˆ†ç±»IDè·å–åˆ†ç±»åç§°
function getCategoryName(catId) {
    let name = "æœªåˆ†ç±»";
    const find = (list) => list.forEach(m => { 
        if(m.id === catId) name = m.name; 
        if(m.children) find(m.children); 
    });
    find(menuData); 
    return name;
}

// ========== å‰å°åšå®¢æ ¸å¿ƒé€»è¾‘ ==========
function renderBlog() {
    document.getElementById('blog-header').innerHTML = `
        <img src="${blogConfig.avatar}" class="avatar">
        <h1>${blogConfig.title}</h1>
        <div class="subtitle">${blogConfig.subtitle}</div>
    `;
    let navHtml = `<ul class="nav-list">`;
    const sortedMenus = sortMenusByCode(menuData);
    sortedMenus.forEach(m => {
        const isActive = currentViewCatId === m.id;
        // âœ… ä¿®å¤é¦–é¡µBUGï¼šç‚¹å‡»é¦–é¡µåŠ è½½æ‰€æœ‰æ–‡ç« 
        const clickFunc = m.name === 'é¦–é¡µ' ? "currentViewCatId='all';blogPage=1;renderBlog()" : `switchView('${m.id}')`;
        navHtml += `<li class="nav-item">
            <a class="nav-link ${isActive ? 'active' : ''}" onclick="${clickFunc}">${m.name}</a>` 
            + (m.children && m.children.length ? `<ul class="dropdown">${renderChildMenu(m.children)}</ul>` : '') 
            + `</li>`; 
    });
    navHtml += `</ul>`;
    document.getElementById('blog-nav').innerHTML = navHtml;
    displayBlogPosts();
}
function renderChildMenu(list) {
    const sorted = sortMenusByCode(list);
    return sorted.map(m => `
        <li><a class="${currentViewCatId === m.id ? 'active' : ''}" onclick="switchView('${m.id}')">${m.name}</a>
            ${m.children && m.children.length ? `<ul class="dropdown">${renderChildMenu(m.children)}</ul>` : ''}
        </li>
    `).join('');
}

function switchView(id) { 
    currentViewCatId = id; 
    blogPage = 1; 
    renderBlog();
}

function displayBlogPosts() {
    const sortedPosts = [...postData].sort((a,b)=>new Date(b.date)-new Date(a.date));
    const filteredPosts = currentViewCatId === 'all' ? sortedPosts : sortedPosts.filter(p => {
        let targetIds = [currentViewCatId];
        const collectChildIds = (list) => list.forEach(m => { 
            if(m.id === currentViewCatId) {
                const getChildren = (cList) => cList.forEach(i => {
                    targetIds.push(i.id);
                    if(i.children) getChildren(i.children);
                });
                getChildren(m.children);
            } else if(m.children) collectChildIds(m.children); 
        });
        collectChildIds(menuData);
        return targetIds.includes(p.categoryId);
    });
    const totalCount = filteredPosts.length;
    const catName = currentViewCatId === 'all' ? 'å…¨ç«™' : getCategoryName(currentViewCatId);
    document.getElementById('post-count').innerText = `${catName}å…±æ”¶å½• ${totalCount} ç¯‡æ–‡ç«  | æŒ‰å‘å¸ƒæ—¶é—´å€’åºæ’åˆ—`;
    const totalPages = Math.ceil(totalCount / pageSize) || 1;
    const paginatedPosts = filteredPosts.slice((blogPage-1)*pageSize, blogPage*pageSize);

    if (totalCount === 0) {
        document.getElementById('post-list').innerHTML = `<div class="empty-tip">ğŸ“‚ æš‚æ— æ–‡ç« æ•°æ®ï¼Œæ•¬è¯·æœŸå¾…</div>`;
    } else {
        document.getElementById('post-list').innerHTML = paginatedPosts.map(p => `
            <a href="${p.url}" target="_blank" class="post-item">
                <span class="post-title" title="${p.title}">${p.title}</span>
                <div class="post-meta">
                    <span class="post-cat-tag">${getCategoryName(p.categoryId)}</span>
                    <span class="post-date">${p.date}</span>
                </div>
            </a>
        `).join('');
    }
    document.getElementById('blog-pagination').innerHTML = totalCount > pageSize ? `
        <button class="page-btn" onclick="blogPage--;displayBlogPosts()" ${blogPage===1?'disabled':''}>â† ä¸Šä¸€é¡µ</button>
        <span style="font-size:14px; color:var(--text-gray);">${blogPage}/${totalPages}</span>
        <button class="page-btn" onclick="blogPage++;displayBlogPosts()" ${blogPage===totalPages?'disabled':''}>ä¸‹ä¸€é¡µ â†’</button>
    ` : '';
}

// ========== åå°ç®¡ç†æ ¸å¿ƒé€»è¾‘ + âœ… æ–°å¢æ£€ç´¢åŠŸèƒ½ ==========
// âœ… æ ¸å¿ƒæ–°å¢ï¼šæ£€ç´¢åšæ–‡ï¼ˆæ ‡é¢˜æ¨¡ç³Š+åˆ†ç±»ç­›é€‰ï¼‰
function searchPosts() {
    adminPage = 1; // æ£€ç´¢æ—¶é‡ç½®é¡µç åˆ°ç¬¬ä¸€é¡µ
    renderAdminPostList(true); // ä¼ å…¥trueè¡¨ç¤ºæ‰§è¡Œæ£€ç´¢
}

function renderAdminPostList(isSearch = false) {
    let sortedPosts = [...postData].sort((a,b)=>new Date(b.date)-new Date(a.date));
    
    // âœ… æ£€ç´¢é€»è¾‘ï¼šæ ‡é¢˜æ¨¡ç³ŠåŒ¹é… + åˆ†ç±»ç²¾å‡†ç­›é€‰
    if(isSearch) {
        const searchTitle = document.getElementById('search-title').value.trim().toLowerCase();
        const searchCatId = document.getElementById('search-cat').value;
        
        // 1. æ ‡é¢˜æ¨¡ç³Šè¿‡æ»¤
        if(searchTitle) {
            sortedPosts = sortedPosts.filter(post => post.title.toLowerCase().includes(searchTitle));
        }
        // 2. åˆ†ç±»ç²¾å‡†è¿‡æ»¤
        if(searchCatId && searchCatId !== 'all') {
            sortedPosts = sortedPosts.filter(post => post.categoryId === searchCatId);
        }
    }

    const totalCount = sortedPosts.length;
    const totalPages = Math.ceil(totalCount / pageSize) || 1;
    const paginatedPosts = sortedPosts.slice((adminPage-1)*pageSize, adminPage*pageSize);

    if (totalCount === 0) {
        document.getElementById('admin-post-list').innerHTML = `<div class="empty-tip">ğŸ” æœªæ£€ç´¢åˆ°åŒ¹é…çš„åšæ–‡</div>`;
    } else {
        document.getElementById('admin-post-list').innerHTML = paginatedPosts.map(p => {
            const originalIndex = postData.indexOf(p);
            return `<div style="border-bottom:1px solid var(--border-color); padding:12px 18px; display:flex; justify-content:space-between; align-items:center; font-size:14px;">
                <span style="flex: 1 1 60%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding-right:15px;" title="${p.title}"><b>[${p.date}]</b> ${p.title}</span>
                <div style="flex: 0 0 30%; text-align:right;">
                    <span style="color:#666; font-size:12px;">${getCategoryName(p.categoryId)}</span>
                    <button class="admin-action-btn" style="color:var(--primary-color);" onclick="startEdit(${originalIndex})">âœï¸</button>
                    <button class="admin-action-btn" style="color:#dc2626;" onclick="deletePost(${originalIndex})">ğŸ—‘ï¸</button>
                </div>
            </div>`;
        }).join('');
    }
    document.getElementById('admin-pagination').innerHTML = totalCount > pageSize ? `
        <button class="page-btn" onclick="adminPage--;renderAdminPostList(true)" ${adminPage===1?'disabled':''}>ä¸Šä¸€é¡µ</button>
        <span style="font-size:13px; color:var(--text-gray);">${adminPage}/${totalPages}</span>
        <button class="page-btn" onclick="adminPage++;renderAdminPostList(true)" ${adminPage===totalPages?'disabled':''}>ä¸‹ä¸€é¡µ</button>
    ` : '';
}

function deletePost(index) {
    if(confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')){
        postData.splice(index,1);
        renderAdminPostList(true);
        renderBlog();
        alert('âœ… æ–‡ç« åˆ é™¤æˆåŠŸ');
    }
}

function handlePostSubmit() {
    const title = document.getElementById('new-p-title').value.trim();
    const date = document.getElementById('new-p-date').value;
    const catId = document.getElementById('new-p-cat').value;
    const url = document.getElementById('new-p-url').value.trim();
    if(!title) return alert('âŒ è¯·å¡«å†™åšæ–‡æ ‡é¢˜');
    if(!url) return alert('âŒ è¯·å¡«å†™åšæ–‡é“¾æ¥');
    if(!date) return alert('âŒ è¯·é€‰æ‹©å‘å¸ƒæ—¥æœŸ');
    const postDataItem = { title, date, categoryId: catId, url };
    if(currentEditingIndex!==null) {
        postData[currentEditingIndex] = postDataItem;
        alert('âœ… æ–‡ç« ä¿®æ”¹æˆåŠŸ');
    } else {
        postData.push(postDataItem);
        alert('âœ… æ–‡ç« æ·»åŠ æˆåŠŸ');
    }
    cancelEdit(); 
    renderAdminPostList(true); 
    renderBlog();
}

function startEdit(index) {
    currentEditingIndex = index; 
    const post = postData[index];
    document.getElementById('new-p-title').value = post.title; 
    document.getElementById('new-p-date').value = post.date;
    document.getElementById('new-p-cat').value = post.categoryId; 
    document.getElementById('new-p-url').value = post.url;
    document.getElementById('form-title').innerText = "âœï¸ ä¿®æ”¹åšæ–‡"; 
    document.getElementById('submit-btn').innerText = "âœ… ä¿å­˜";
    document.getElementById('submit-btn').className = "btn-main btn-edit";
    document.getElementById('cancel-edit-btn').style.display = "block";
}

function cancelEdit() {
    currentEditingIndex = null; 
    document.getElementById('new-p-title').value = "";
    document.getElementById('new-p-date').valueAsDate = new Date();
    document.getElementById('new-p-url').value = "";
    document.getElementById('form-title').innerText = "ğŸ“ å½•å…¥åšæ–‡"; 
    document.getElementById('submit-btn').innerText = "âœ… å‘å¸ƒ";
    document.getElementById('submit-btn').className = "btn-main btn-add";
    document.getElementById('cancel-edit-btn').style.display = "none";
}

function toggleAdmin() { 
    const panel = document.getElementById('admin-panel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
}

// ========== ç¼–ç å¼èœå•ç®¡ç†æ ¸å¿ƒé€»è¾‘ ==========
function renderMenuEditor() {
    const sel = document.getElementById('new-p-cat'); sel.innerHTML = "";
    const searchSel = document.getElementById('search-cat');
    // é‡ç½®æ£€ç´¢åˆ†ç±»ä¸‹æ‹‰æ¡†ï¼Œä¿ç•™é»˜è®¤ã€Œå…¨éƒ¨åˆ†ç±»ã€
    searchSel.innerHTML = `<option value="all">ğŸ“‚ å…¨éƒ¨åˆ†ç±»</option>`;
    
    const build = (list, d=0) => {
        return list.map(m => {
            sel.innerHTML += `<option value="${m.id}">${'â€”'.repeat(d)} ${m.name}</option>`;
            searchSel.innerHTML += `<option value="${m.id}">${'â€”'.repeat(d)} ${m.name}</option>`;
            return `<div style="margin-left:${d*20}px;margin-top:5px;">
                <input type="text" class="code-input" value="${m.code}" onblur="updateMenuCode('${m.id}', this.value)" placeholder="ç¼–ç ">
                <input value="${m.name}" oninput="mName('${m.id}',this.value)"> 
                <button onclick="addM('${m.id}')">+</button> 
                <button onclick="delM('${m.id}')" style="color:red">x</button>
                ${m.children?build(m.children,d+1):''}
            </div>`;
        }).join('');
    };
    document.getElementById('menu-editor').innerHTML = build(menuData);
}

function mName(id,v){ const f=l=>l.forEach(m=>{if(m.id===id)m.name=v; if(m.children)f(m.children)}); f(menuData); renderBlog();}
function addRootMenu(){ 
    const maxCode = menuData.length > 0 ? Math.max(...menuData.map(m => parseInt(m.code))) : 0;
    menuData.push({id:'m'+Date.now(), code: (maxCode + 1).toString(), name:'æ–°åˆ†ç±»', children:[]}); 
    renderMenuEditor(); 
}
function addM(pid){ 
    let parentMenu = null;
    const findParent = (list) => list.forEach(m => {
        if(m.id === pid) parentMenu = m;
        else if(m.children) findParent(m.children);
    });
    findParent(menuData);
    const childCode = parentMenu.code + '-' + (parentMenu.children.length + 1);
    parentMenu.children.push({id:'m'+Date.now(), code: childCode, name:'å­åˆ†ç±»', children:[]}); 
    renderMenuEditor(); 
}
function delM(id){ if(!confirm('åˆ åˆ†ç±»?'))return; const f=l=>l.filter(m=>{if(m.id===id)return false; m.children=f(m.children); return true;}); menuData=f(menuData); renderMenuEditor(); renderBlog(); }

function updateMenuCode(menuId, newCode) {
    if(!newCode) return alert('âŒ ç¼–ç ä¸èƒ½ä¸ºç©º');
    const findMenu = (list) => list.forEach(m => {
        if(m.id === menuId) m.code = newCode;
        else if(m.children) findMenu(m.children);
    });
    findMenu(menuData);
    resetMenuStructureByCode();
    alert('âœ… ç¼–ç ä¿®æ”¹æˆåŠŸï¼Œèœå•å±‚çº§å·²è‡ªåŠ¨æ›´æ–°');
}

function resetMenuStructureByCode() {
    const allMenus = [];
    const flattenMenus = (list) => list.forEach(m => {
        allMenus.push(m);
        if(m.children) flattenMenus(m.children);
    });
    flattenMenus(menuData);

    menuData.forEach(m => m.children = []);
    const rootMenus = [];

    allMenus.forEach(menu => {
        const codeArr = menu.code.split('-');
        if(codeArr.length === 1) {
            rootMenus.push(menu);
            menu.children = [];
        } else {
            const parentCode = codeArr.slice(0, -1).join('-');
            const parentMenu = allMenus.find(m => m.code === parentCode);
            if(parentMenu) {
                if(!parentMenu.children) parentMenu.children = [];
                parentMenu.children.push(menu);
                menu.children = [];
            } else {
                alert(`âš ï¸ ç¼–ç ã€${menu.code}ã€‘çš„çˆ¶ç¼–ç ã€${parentCode}ã€‘ä¸å­˜åœ¨ï¼Œå·²è®¾ä¸ºä¸€çº§èœå•`);
                rootMenus.push(menu);
            }
        }
    });

    menuData.length = 0;
    menuData.push(...sortMenusByCode(rootMenus));
    renderMenuEditor();
    renderBlog();
}

function sortMenusByCode(menuList) {
    return [...menuList].sort((a, b) => {
        const aCodes = a.code.split('-').map(Number);
        const bCodes = b.code.split('-').map(Number);
        const maxLen = Math.max(aCodes.length, bCodes.length);
        for(let i=0; i<maxLen; i++) {
            const aVal = aCodes[i] || 0;
            const bVal = bCodes[i] || 0;
            if(aVal !== bVal) return aVal - bVal;
        }
        return 0;
    });
}

// ========== åšå®¢é…ç½®ç®¡ç† ==========
function initBlogConfigForm() {
    document.getElementById('config-title').value = blogConfig.title;
    document.getElementById('config-subtitle').value = blogConfig.subtitle;
    document.getElementById('config-avatar').value = blogConfig.avatar;
}
function saveBlogConfig() {
    blogConfig.title = document.getElementById('config-title').value.trim();
    blogConfig.subtitle = document.getElementById('config-subtitle').value.trim();
    blogConfig.avatar = document.getElementById('config-avatar').value.trim();
    if(!blogConfig.title) return alert('âŒ åšå®¢æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
    renderBlog();
    alert('âœ… åšå®¢åŸºç¡€ä¿¡æ¯ä¿®æ”¹æˆåŠŸï¼');
}

// ========== å¯¼å‡ºä¿å­˜é€»è¾‘ ==========
function exportAndSave() {
    document.getElementById('admin-panel').style.display = 'none';
    const htmlContent = document.documentElement.outerHTML;
    const dataString = `let blogConfig = ${JSON.stringify(blogConfig, null, 4)};\nlet menuData = ${JSON.stringify(menuData, null, 4)};\nlet postData = ${JSON.stringify(postData, null, 4)};`;
    const finalHtml = htmlContent.replace(/let blogConfig = \{[\s\S]*?\};[\s\S]*?let menuData = \[[\s\S]*?\];[\s\S]*?let postData = \[[\s\S]*?\];/, dataString);
    const blob = new Blob([finalHtml], {type: 'text/html; charset=utf-8'});
    const downloadLink = document.createElement('a'); 
    downloadLink.href = URL.createObjectURL(blob); 
    downloadLink.download = `BTC2054åšå®¢_${new Date().toLocaleDateString().replace(/\//g,'-')}.html`; 
    downloadLink.click();
    URL.revokeObjectURL(downloadLink.href);
    alert(`âœ… æ•°æ®ä¿å­˜æˆåŠŸï¼\næ–‡ä»¶åï¼š${downloadLink.download}\nå·²è‡ªåŠ¨ä¸‹è½½åˆ°æœ¬åœ°ï¼Œè¯·å¦¥å–„å¤‡ä»½`);
}

window.onload = init;
</script>
</body>
</html>